<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>توجيه تقني: تأمين مجلد الإرفاق وتطبيق قواعد الإدارة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.8; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 25px 40px; }
        .header { text-align: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; margin: 0; }
        .header-meta { margin-top: 10px; font-size: 0.9em; color: #7f8c8d; }
        .section { margin-bottom: 35px; border-bottom: 1px dashed #ccc; padding-bottom: 25px; }
        .section:last-child { border-bottom: none; padding-bottom: 0; }
        h2 { color: #0056b3; border-right: 4px solid #0056b3; padding-right: 10px; margin-bottom: 20px; }
        h3 { color: #34495e; margin-top: 25px; }
        h4 { color: #e67e22; font-weight: 700; }
        
        code, pre { font-family: 'Courier New', Courier, monospace; background-color: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; direction: ltr; text-align: left; border: 1px solid #333; display: block; overflow-x: auto; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        code .comment { color: #6a9955; font-style: italic; }
        code .variable { color: #9cdcfe; }
        code .keyword { color: #c586c0; font-weight: bold; }
        code .string { color: #ce9178; }
        code .function-name { color: #dcdcaa; }
        code .operator { color: #d4d4d4; }
        code .shell-command { color: #9cdcfe; font-weight: bold; }
        code .shell-path { color: #ce9178; }
        code .html-tag { color: #569cd6; }
        code .html-attr { color: #9cdcfe; }
        code .html-string { color: #ce9178; }
        
        .action-item { font-weight: bold; color: #7f8c8d; display: block; margin-bottom: 10px; }
        .alert { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }
        .alert-info { background-color: #d9edf7; color: #31708f; border-color: #bce8f1; }
        .alert-warning { background-color: #fcf8e3; color: #8a6d3b; border-color: #faebcc; }
        .alert-success { background-color: #dff0d8; color: #3c763d; border-color: #d6e9c6; text-align: center; font-weight: bold; }
        .alert-success a { color: #2b5a2b; font-weight: bold; text-decoration: underline; }
        .alert-danger { background-color: #f2dede; color: #a94442; border-color: #ebccd1; }
        .path { color: #d9534f; font-weight: 600; background-color: #fdf2f2; padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .highlight-blue { color: #0056b3; font-weight: bold; }
        .highlight-red { color: #a94442; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">

        <div class="header">
            <h1>توجيه تقني: تطبيق تغيير مسار الإرفاق الأمني وقواعد الإدارة</h1>
            <div class="header-meta">
                إعداد: آيت أمقران صالح
                <span style="margin: 0 10px;">|</span>
                تاريخ: 03 نوفمبر 2025
            </div>
        </div>

        <div class="section">
            <h2>1. الهدف</h2>
            <div class="alert alert-success">
                ملاحظة: تحميل الملفات المعدلة <a href="folder.zip" download="folder.zip">folder.zip</a>
            </div>
            <p>نقل مجلد `uploads` إلى <span class="path">/var/www/uploads</span>، وتطبيق قواعد الإدارة الجديدة الخاصة بمتعلمي إعادة التربية (`FRAIS=1500`) وأبناء العمال (`PAYE=1500`)، وإضافة بيانات المتعلم لوصل الإرفاق.</p>
        </div>

        <div class="section">
            <h2>2. المرحلة الأولى: تغييرات الخادم (SysAdmin)</h2>
            <strong class="action-item">1. نقل المجلد:</strong>
            <pre><code><span class="shell-command">sudo</span> mv <span class="shell-path">/var/www/html/preinscription/uploads</span> <span class="shell-path">/var/www/uploads</span></code></pre>
            
            <strong class="action-item">2. ضبط الصلاحيات:</strong>
            <pre><code><span class="shell-command">sudo</span> chown -R www-data:www-data <span class="shell-path">/var/www/uploads</span>
<span class="shell-command">sudo</span> chmod -R 775 <span class="shell-path">/var/www/uploads</span></code></pre>
        </div>

        <div class="section">
            <h2>3. المرحلة الثانية: تعديل الواجهة الخلفية (CodeIgniter)</h2>
            <p><strong class="action-item">الملف المستهدف:</strong> <span class="path">application/controllers/Upload_documents.php</span></p>

            <h3>3.1 - تعديل دالة `verify_student()` (لتطبيق القواعد الجديدة)</h3>
            <p>هذا هو التعديل الأهم. يجب أن نتحقق من حالة المتعلم ونحفظها في الجلسة.</p>
            <pre><code>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function-name">verify_student</span>()
    {
        <span class="comment">// ... (منطق التحقق من الكابتشا وتاريخ الميلاد) ...</span>

        <span class="keyword">if</span> (<span class="variable">$this</span><span class="operator">-></span><span class="variable">form_validation</span><span class="operator">-></span><span class="function-name">run</span>() <span class="operator">==</span> <span class="keyword">FALSE</span>) {
            <span class="comment">// ...</span>
        } <span class="keyword">else</span> {
            <span class="comment">// ... (بناء بيانات البحث) ...</span>
            <span class="variable">$student</span> <span class="operator">=</span> <span class="variable">$this</span><span class="operator">-></span><span class="variable">M_inscriptic_eleve</span><span class="operator">-></span><span class="function-name">inseleve_rechercheENBR_DNS</span>(<span class="variable">$param</span>);

            <span class="keyword">if</span> (<span class="variable">$student</span>) {
                <span class="comment">// =================================================================</span>
                <span class="comment">// تطبيق القواعد الجديدة للإدارة</span>
                <span class="comment">// =================================================================</span>
                <span class="variable">$is_paid</span> <span class="operator">=</span> (<span class="variable">$student</span><span class="operator">-></span><span class="variable">PAYE</span> <span class="operator">==</span> 1);
                <span class="variable">$is_worker_child</span> <span class="operator">=</span> (<span class="variable">$student</span><span class="operator">-></span><span class="variable">PAYE</span> <span class="operator">==</span> 1500);
                <span class="variable">$is_reeducation</span> <span class="operator">=</span> (<span class="variable">$student</span><span class="operator">-></span><span class="variable">FRAIS</span> <span class="operator">==</span> 1500);

                <span class="keyword">if</span> (<span class="operator">!</span><span class="variable">$is_paid</span> <span class="operator">&amp;&amp;</span> <span class="operator">!</span><span class="variable">$is_worker_child</span> <span class="operator">&amp;&amp;</span> <span class="operator">!</span><span class="variable">$is_reeducation</span>) {
                    <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">set_flashdata</span>(<span class="string">'upload_error'</span>, <span class="string">'لا يمكنك إرفاق الوثائق. يجب عليك دفع حقوق التسجيل أولاً.'</span>);
                    <span class="variable">$this</span><span class="operator">-></span><span class="function-name">_show_auth_page_with_error</span>(<span class="variable">$code_annexe</span>);
                    <span class="keyword">return</span>;
                }
                
                <span class="comment">// ... (التحقق من الإرفاق المسبق) ...</span>

                <span class="variable">$is_returning_student</span> <span class="operator">=</span> (<span class="variable">$student</span><span class="operator">-></span><span class="variable">ANNEEINS</span> <span class="operator">&lt;</span> 2026);
                <span class="variable">$requires_extra_docs</span> <span class="operator">=</span> <span class="keyword">false</span>;
                
                <span class="comment">// الوثائق الإضافية مطلوبة فقط للمتعلمين الجدد (العاديين أو أبناء العمال)</span>
                <span class="keyword">if</span> (<span class="operator">!</span><span class="variable">$is_returning_student</span> <span class="operator">&amp;&amp;</span> (<span class="variable">$is_paid</span> <span class="operator">||</span> <span class="variable">$is_worker_child</span>)) {
                    <span class="variable">$birth_date_obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="function-name">DateTime</span>(<span class="variable">$student</span><span class="operator">-></span><span class="variable">DNS</span>);
                    <span class="variable">$cutoff_date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="function-name">DateTime</span>(<span class="string">'1800-01-01'</span>); <span class="comment">// التاريخ المعدل</span>
                    <span class="keyword">if</span> (<span class="variable">$birth_date_obj</span> <span class="operator">&lt;</span> <span class="variable">$cutoff_date</span>) {
                        <span class="variable">$requires_extra_docs</span> <span class="operator">=</span> <span class="keyword">true</span>;
                    }
                }
                
                <span class="variable">$session_data</span> <span class="operator">=</span> [
                    <span class="string">'upload_student_enpr'</span> <span class="operator">=></span> <span class="variable">$student</span><span class="operator">-></span><span class="variable">ENPR</span>,
                    <span class="string">'upload_student_name'</span> <span class="operator">=></span> <span class="variable">$student</span><span class="operator">-></span><span class="variable">NOM</span> <span class="operator">.</span> <span class="string">' '</span> <span class="operator">.</span> <span class="variable">$student</span><span class="operator">-></span><span class="variable">PRENOM</span>,
                    <span class="string">'upload_student_dns'</span> <span class="operator">=></span> <span class="variable">$student</span><span class="operator">-></span><span class="variable">DNS</span>, <span class="comment">// لإضافته للوصل</span>
                    <span class="string">'upload_student_annexe'</span> <span class="operator">=></span> <span class="variable">$student</span><span class="operator">-></span><span class="variable">ANNEXE</span>,
                    <span class="string">'is_returning_student'</span> <span class="operator">=></span> <span class="variable">$is_returning_student</span>,
                    <span class="string">'is_reeducation_student'</span> <span class="operator">=></span> <span class="variable">$is_reeducation</span>,
                    <span class="string">'is_worker_child'</span> <span class="operator">=></span> <span class="variable">$is_worker_child</span>,
                    <span class="string">'requires_extra_docs'</span> <span class="operator">=></span> <span class="variable">$requires_extra_docs</span>
                ];
                <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">set_userdata</span>(<span class="variable">$session_data</span>);
                <span class="function-name">redirect</span>(<span class="string">'upload_documents/upload_form'</span>);
            } <span class="comment">// ...</span>
        }
    }
            </code></pre>

            <h3>3.2 - تعديل دالة `do_upload()` (لتطبيق القواعد الجديدة)</h3>
            <p>هنا نقرأ الحالات من الجلسة لنقرر ما هي الملفات الإجبارية وما هو المسار الصحيح.</p>
            <pre><code>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function-name">do_upload</span>()
    {
        <span class="comment">// ... (جلب بيانات الجلسة)</span>
        <span class="variable">$is_returning</span> <span class="operator">=</span> <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">userdata</span>(<span class="string">'is_returning_student'</span>);
        <span class="variable">$is_reeducation</span> <span class="operator">=</span> <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">userdata</span>(<span class="string">'is_reeducation_student'</span>);
        <span class="variable">$requires_extra</span> <span class="operator">=</span> <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">userdata</span>(<span class="string">'requires_extra_docs'</span>);
        
        <span class="variable">$all_possible_files</span> <span class="operator">=</span> [ <span class="comment">/* ... */</span> ];
        <span class="variable">$required_inputs</span> <span class="operator">=</span> []; <span class="comment">// قائمة الملفات الإجبارية</span>

        <span class="keyword">if</span> (<span class="variable">$is_returning</span>) {
            <span class="variable">$required_inputs</span> <span class="operator">=</span> [<span class="string">'doc_payment'</span>];
        } <span class="keyword">elseif</span> (<span class="variable">$is_reeducation</span>) {
            <span class="variable">$required_inputs</span> <span class="operator">=</span> [<span class="string">'doc_birth'</span>]; <span class="comment">// إجبارية شهادة الميلاد فقط</span>
        } <span class="keyword">else</span> {
            <span class="comment">// متعلم جديد (عادي أو ابن عامل)</span>
            <span class="variable">$required_inputs</span> <span class="operator">=</span> [<span class="string">'doc_payment'</span>, <span class="string">'doc_birth'</span>, <span class="string">'doc_photo'</span>, <span class="string">'doc_statement'</span>];
            <span class="keyword">if</span> (<span class="variable">$requires_extra</span>) {
                <span class="variable">$required_inputs</span> <span class="operator">=</span> <span class="function-name">array_merge</span>(<span class="variable">$required_inputs</span>, [<span class="string">'doc_school'</span>, <span class="string">'doc_grades'</span>]);
            }
        }
        
        <span class="comment">// التعديل 1: تغيير مسار الرفع</span>
        <span class="variable">$upload_base_path</span> <span class="operator">=</span> <span class="string">'/var/www/uploads/'</span>;
        <span class="variable">$wilaya_path</span> <span class="operator">=</span> <span class="variable">$upload_base_path</span> <span class="operator">.</span> <span class="variable">$annexe</span> <span class="operator">.</span> <span class="string">'/'</span>;
        <span class="comment">// ...</span>
        
        <span class="comment">// ... (التحقق من الملفات الإجبارية المفقودة) ...</span>
        
        <span class="keyword">foreach</span> (<span class="variable">$all_possible_files</span> <span class="keyword">as</span> <span class="variable">$input_name</span> <span class="operator">=></span> <span class="variable">$file_info</span>) {
            <span class="keyword">if</span> (<span class="operator">!</span><span class="function-name">empty</span>(<span class="variable">$_FILES</span>[<span class="variable">$input_name</span>][<span class="string">'name'</span>])) {
                <span class="comment">// ... (منطق الرفع وإعادة التسمية)</span>
                <span class="keyword">if</span> (<span class="variable">$this</span><span class="operator">-></span><span class="variable">upload</span><span class="operator">-></span><span class="function-name">do_upload</span>(<span class="variable">$input_name</span>)) {
                    <span class="variable">$upload_data</span> <span class="operator">=</span> <span class="variable">$this</span><span class="operator">-></span><span class="variable">upload</span><span class="operator">-></span><span class="function-name">data</span>();
                    <span class="comment">// التعديل 2: حفظ اسم الملف فقط</span>
                    <span class="variable">$uploaded_urls</span>[<span class="variable">$file_info</span>[<span class="string">'db_column'</span>]] <span class="operator">=</span> <span class="variable">$upload_data</span>[<span class="string">'file_name'</span>];
                } <span class="comment">// ...</span>
            }
        }
        
        <span class="comment">// ... (معالجة الأخطاء ومنطق الحفظ) ...</span>
    }
            </code></pre>

            <h3>3.3 - تعديل دالة `_show_success_page()` (لإضافة بيانات الوصل)</h3>
            <pre><code>
    <span class="keyword">private</span> <span class="keyword">function</span> <span class="function-name">_show_success_page</span>(<span class="variable">$uploaded_files</span>)
    {
        <span class="comment">// ... (تجهيز $display_files) ...</span>
        <span class="variable">$data</span>[<span class="string">'uploaded_files_display'</span>] <span class="operator">=</span> <span class="variable">$display_files</span>;
        
        <span class="comment">// =================================================================</span>
        <span class="comment">// التعديل 3: إضافة بيانات المتعلم للوصل</span>
        <span class="comment">// =================================================================</span>
        <span class="variable">$data</span>[<span class="string">'student_info'</span>] <span class="operator">=</span> [
            <span class="string">'enpr'</span> <span class="operator">=></span> <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">userdata</span>(<span class="string">'upload_student_enpr'</span>),
            <span class="string">'name'</span> <span class="operator">=></span> <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">userdata</span>(<span class="string">'upload_student_name'</span>),
            <span class="string">'dns'</span> <span class="operator">=></span> <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">userdata</span>(<span class="string">'upload_student_dns'</span>)
        ];
        
        <span class="variable">$this</span><span class="operator">-></span><span class="function-name">load</span><span class="operator">-></span><span class="function-name">view</span>(<span class="string">'preinscription/upload/upload_success_view'</span>, <span class="variable">$data</span>);
        <span class="comment">// ...</span>
        <span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">sess_destroy</span>();
    }
            </code></pre>

            <h3>3.4 - إضافة "البوابة الآمنة" (Gatekeeper)</h3>
            <p>أضف هذه الدالة <span class="highlight-blue">الجديدة</span> إلى ملف <span class="path">application/controllers/Upload_documents.php</span>.</p>
            <pre><code>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function-name">view_file</span>(<span class="variable">$file_name</span> <span class="operator">=</span> <span class="string">''</span>)
    {
        <span class="comment">// هذا الكود سيعمل فقط إذا لم تُدمر الجلسة بعد</span>
        <span class="comment">// أو يجب أن يعتمد على نظام مصادقة منفصل.</span>
        <span class="comment">// للتوافق مع صفحة النجاح، نفترض أن الجلسة ما زالت نشطة</span>
        
        <span class="keyword">if</span> (<span class="operator">!</span><span class="variable">$this</span><span class="operator">-></span><span class="variable">session</span><span class="operator">-></span><span class="function-name">userdata</span>(<span class="string">'upload_student_enpr'</span>)) {
             <span class="comment">// إذا دُمرت الجلسة، يجب أن نعيد المستخدم لصفحة التحقق</span>
             <span class="function-name">redirect</span>(<span class="string">'upload_documents'</span>);
             <span class="keyword">return</span>;
        }
        <span class="comment">// ... (باقي كود التحقق من الملف وتقديمه) ...</span>
    }
            </code></pre>
        </div>

        <div class="section">
            <h2>4. المرحلة الرابعة: تحديث الواجهة الأمامية (Views)</h2>
            <p>يجب تحديث الواجهات لتعكس الحالات المختلفة (متعلم قديم، إعادة تربية، متعلم جديد).</p>
            
            <p><strong class="action-item">الملف المستهدف:</strong> <span class="path">application/views/preinscription/upload/upload_form_view.php</span></p>
            <p>يجب أن يحتوي الملف على منطق `if/elseif/else` لعرض الحقول الصحيحة لكل حالة، مع إضافة `required` للملفات الإجبارية فقط.</p>
            
             <p><strong class="action-item">الملف المستهدف:</strong> <span class="path">application/views/preinscription/upload/upload_success_view.php</span></p>
             <p>يجب تحديث هذا الملف لإضافة بيانات المتعلم (النقطة 2 من طلب الإدارة) وتطبيق "الحل (أ)" أو "الحل (ب)" (من الدليل السابق) لمعالجة مشكلة الروابط القديمة والجديدة.</p>
        </div>
    </div>

</body>
</html>

